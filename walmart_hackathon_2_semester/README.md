# Проектный практикум 2 семестра магистратуры "Науки о данных" МФТИ

### Состав команды и роли:
1. **Лещенко Борис** (тимлид) - моделирование решения, визуализация данных, документирование, описание проекта;
2. **Оскина Надежда** - разведывательный анализ данных (EDA), разработка ансамблевых моделей (Random Forest, XGBoost, CatBoost);
3. **Сысуев Никита** - очистка данных, генерация признаков (feature engineering), разработка нейросетевых моделей.

## Кейс Forecast NOW:: Анализ влияния погодных условий на продажи товаров 
***Цель проекта:*** "Разработать аналитическую модель, позволяющую оценивать влияние погодных условий (температуры воздуха и осадков) на продажи товаров в различных географических локациях. В основе модели — система коэффициентов, корректирующих прогноз спроса в зависимости от погодного прогноза на предстоящие периоды (неделя, месяц, сезон)."

### Ключевые аспекты реализации
- Решение должно учитывать временные периоды разной длительности (неделя/месяц/сезон)
- Для каждого товара рассчитывается коэффициент влияния погодных параметров
- Требуется географическая привязка данных к регионам поставок
- Решение должно быть интерпретируемым для бизнес-пользователей

### Источники данных
В качестве исходных данных используются открытые датасеты с Kaggle: [Walmart Recruiting II: Sales in Stormy Weather](https://www.kaggle.com/competitions/walmart-recruiting-sales-in-stormy-weather/data)
*Эти данные включают:*
- Исторические данные о продажах по магазинам и товарам;
- Исторические метеоданные (температура, осадки и др.);
- Географическую привязку магазинов к метеостанциям;
- Координаты магазинов (частично дополнены искусственно на основе базы магазинов Walmart).

### Структура проекта:
```plaintext
project-root/
├── data/                                 # ВСЕ ТЯЖЕЛЫЕ csv-файлы (более 100Мб) игнорируется в Git через .gitignore
│   ├── 00_raw/                           # Исходные неизменяемые данные
│   │   ├── all_stores.csv                # Координаты магазинов
│   │   ├── key_whs.csv                   # Соответствие магазинов и складов (искусственный файл для демонстрации решения)
│   │   ├── key.csv                       # Соответствие магазинов и метеостанций
|   │   ├── train.csv                     # Исторические данные по продажам
|   │   └── weather.csv                   # Сырые погодные данные
|   │
│   ├── 01_intermediate/                  # Промежуточные преобразованные данные. Результаты очистки и преобразований
│   │   ├── clear_train.csv               # Очищенный датасет с историческими данными по продажам
│   │   ├── filtered_units.csv            # Очищенный список товаров, по которым есть продажи
│   │   ├── merged_train_norm.csv         # Очищенный и объединенный датасет с данными по погоде (нормированный по признакам)
|   │   ├── merged_train.csv              # Очищенный и объединенный датасет с данными по погоде
│   │   └── weather_filtered.csv          # Очищенные погодные данные
|   │
│   ├── 02_processed/                     # Готовые наборы для обучения/тестирования
│   │   ├── X_test.csv                    # Признаки для тестирования
│   │   ├── X_train.csv                   # Признаки для обучения
|   │   ├── y_test.csv                    # Истинные значения для тестирования
|   │   └── y_train.csv                   # Целевая переменная для обучения
|   │
│   ├── 03_weather_forecast/              # Файлы прогнозов погоды, используемые моделями на входе для прогноза продаж
│   │   ├── weater_forecast_day.csv       # Прогноз погоды на X дней
│   │   ├── weater_forecast_7day.csv      # Прогноз погоды на X дней
|   │   ├── weater_forecast_30day.csv     # Прогноз погоды на X дней
|   │   └── weater_forecast_season.csv    # Прогноз погоды на X дней
|   │
│   ├── 04_models/                        # Файлы обученных моделей
│   │   ├── cat_model.joblib              # CatBoostRegressor 
│   │   ├── forest_model.joblib           # Случайный лес    
|   │   ├── lgbm_model.joblib             # LGBMRegressor   
|   │   ├── tree_model.joblib             # Решающее дерево  
│   │   └── xgb_model.joblib              # XGBRegressor 
|   │
│   └── 05_results/                       # Результаты предсказаний и анализа
│       ├── pred_7days.csv                # Предсказания на 7 дней
│       ├── pred_30days.csv               # Предсказания на 30 дней
|       ├── pred_day.csv                  # Предсказания на 1 день
|       ├── pred_season.csv               # Предсказания на сезон
│       ├── shap_7days.csv                # Shap-коэффициенты по предсказанию на 7 дней
│       ├── shap_30days.csv               # Shap-коэффициенты по предсказанию на 30 дней
|       ├── shap_day.csv                  # Shap-коэффициенты по предсказанию на 1 день
|       └── shap_season.csv               # Shap-коэффициенты по предсказанию на сезон
│         
├── notebooks/                            # Jupyter-ноутбуки с исследованиями
│   └── 01_walmart.ipynb                  # Первичная обработка данных, разведывательный анализ (EDA)
├── Visual.pbix                           # Файл Power BI с визуализацией результата. 
├── requirements.txt                      # Зависимости проекта 
└── README.md                             # Описание проекта
```

### В рамках реализации проекта выполнены следующие этапы работ:
 - исследованы исходные данные на предмет достаточности информации, типов данных, размеров датасетов и возможности их маппинга;
 - типы данных приведены к правильным, необходимым для будущих расчетов;
 - дозаполнены данные по координатам магазинов (рандомно из базы магазинов Walmart);
 - проведен расследовательный анализ данных (EDA), а так же корреляционный анализ. Удалены признаки с высокой корреляцией, а так же признаки, в которых наблюдается большое количество пропусков и которые не подлежать восстановлению (подробное описание в файле-ноутбука);
 - добавлены признаки сезонности, а так же метрические данные погоды приведены к принятым в РФ (градусы Цельсия и осадки в мм., а не дюймах);
 - проведен merge данных в единый датасет для дальнейшей подготовки train и test датасетов для построении моделей ИИ.
 - подготовлены обучающие и тестовые выборки;
 - произведено моделирование: расчёт коэффициентов влияния погодных условий с помощью линейных моделей, ансамблевых методов (Random Forest, XGBoost, CatBoost, LGBMRegressor) и с использованием нейросетевых подходов;
 - произведен выбор оптимального подхода — по точности, гибкости и интерпретируемости (подробное описание ниже по тексту, а так же в файле-ноутбуке);
 - произведены расчеты прогнозов продаж на основе случайных данных по прогнозу погоду (получены рандомным образом на основе исходного файла по погоде), а так же рассчитаны shap-коэффициенты влияния температуры и осадков на продажи;
 - реализована визуализация демонстрирующая возможное использование прогнозных данных по продажам и shap-коэффициентов для интерпритации влияния погодны на продажи — построены интерактивных графики/дашборды (с использованием Power BI) [Сссылка на дашборд в Интернет](https://app.powerbi.com/view?r=eyJrIjoiMTVkOWZkYjMtYWYzMi00ZDkyLWFjNjAtMjQyZGE2NWNmYzQ2IiwidCI6IjMzNjE1YzUyLTY3ZGUtNDlkYy05OWMyLWMzYjk0NjUzNmY5YyIsImMiOjEwfQ%3D%3D);
 - произведено документирование и подготовка к защите — README, подготовка презентации, отчёта и скриптов.


### Итоги выбора модели для прогнозирования продаж и оценки влияния погоды на продажи (Справочно. Более подробно в файле ноутбука)
#### **Сравнительная таблица моделей**

| Модель            | R² Score ↑ | MAPE ↓     | Вывод                 |
| ----------------- | ---------- | ---------- | --------------------- |
| **✅ LightGBM**    | **0.7672** | 0.9312     | Лучшая по R²          |
| **Random Forest** | 0.7413     | **0.6135** | Самая точная (MAPE)   |
| Decision Tree     | 0.7116     | 0.6245     | Простая и быстрая     |
| CatBoost          | 0.6443     | 1.1429     | Уступает другим       |
| XGBoost           | 0.5478     | 1.1846     | Хуже всех по метрикам |

#### **Интерпретация результатов**

##### LightGBM

* **Лучшая модель по объясняющей способности** (`R² = 0.7672`).
* Однако по точности прогноза (MAPE) уступает Random Forest.

##### Random Forest

* **Лучшая модель по абсолютной ошибке** (`MAPE = 0.6135`).
* Высокий `R²` делает её сбалансированным выбором.

##### Decision Tree

* Неплохие метрики.
* Подходит, если важна интерпретируемость и скорость.

##### CatBoost и XGBoost

* Оба сильно проигрывают по MAPE.
* Вероятные причины: плохая чувствительность к распределению целевой переменной, нехватка настройки, либо переобучение.  

В ходе сравнения была выбрана RandomForestRegressor в качестве модели для определения основного прогнозирования продаж и расчета влияния погоды с помощью shap-коэффициентов.

### Как запустить код локально:  
 - использовать файл requirements.txt в качестве устоновок нужных версий библиотек;
 - сохранить структуру папок и файлов к себе на компьютер;
 - запустить все ячейки ноутбука последовательно.
